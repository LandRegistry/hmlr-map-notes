{% extends "layouts/main.html" %}
{% set serviceName= "HMLR [Example drawing tools]" %}
{% set pageName="Draw controls test" %}

{% set bodyClasses = "full-width" %}
{% set containerClasses = "full-width" %}


{% block beforeContent %}
<style>

  .navbar {
    display: inline;
    min-width: 180px;
    max-width: 300px;
    overflow: hidden;
    padding-right: 10px;
  }

  .govuk-grid-column-20-percent {
    width: 20%;
    box-sizing: border-box;
    padding: 0 15px;
    float: left;
  }

  .govuk-main-wrapper {
    padding-top: 10px;
    padding-bottom: 10px;
  }

  .govuk-width-container {
    max-width: 98%;
    width: 98%;
  }

  .govuk-footer {
    display: none;
  }

  .max-width {
    width: calc(100% - 300px);
    float: left;
  }

 

.attribution{
  font-size: 0.875rem;
  padding-top: 5px;
  padding-bottom: 5px;
}
</style>
{% endblock %}



{% block content %}
<div id="container" class="govuk-grid-row">

  <div class="navbar govuk-grid-column-20-percent">

    <h2 class="govuk-heading-s govuk-!-padding-top-3">
      Draw boundary
    </h2>

    {% include "/includes/controls.html" %}
  </div>

  <div class="max-width">
    {{ hmlrMap({
      alt: "HMLR map component",
      caption: "Â© Crown copyright and database rights 2025 Ordnance Survey AC0000XXXXXX. Use of this data is subject to Ordnance Survey",
      width: "100%",
      height: "100%",
      layer_controls: "false",
      coords: "249050,59150",
      zoom: 18,
      layers:[
        {
          description:"Registrations (INSPIRE)",
          interactive: "true",
          style: {
            fill: {
              color: "#4c2c9244"
            },
            stroke: {
              color: "#4c2c9299",
              width: 1
            }
          }
        },
          {
          description:"Postcode",
          style: {
            fill: {
              color: "#d4351c33"
            },
            stroke: {
              color: "#d4351c",
              width: 3,
              lineDash: [10, 6]
            }
          }
        }
      ],
      tile_url: 'https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
    }) }}

  </div>

</div>


{% endblock %}





{% block pageScripts %}
<script>
  var retrievedMap;
  
  function setElementHeight(selector) {
    const el = document.querySelector(selector);
    if (!el) return;

    function updateHeight() {
      el.style.height = window.innerHeight - 170 + 'px';
    }

    // Run on load and resize
    window.addEventListener('load', updateHeight);
    window.addEventListener('resize', updateHeight);
  }

  setElementHeight('.hmlr-map-wrapper');
  setElementHeight('.navbar');

  function exportGeometries() {
    console.log('export');
    const data = getGeometries();
    console.log(data);

    // Create timestamp in format: YYYY-MM-DD_HH-MM-SS
    const now = new Date();
    const timestamp = now.toISOString().replace(/:/g, '-').replace(/\..+/, '').replace('T', '_');
  
    const filename = timestamp +'.json';
    // Create a Blob from the JSON string
    const blob = new Blob([data], { type: 'application/json' });
    
    // Create a temporary URL for the Blob
    const url = URL.createObjectURL(blob);
  
    // Create a temporary anchor element and trigger download
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
  
    // Clean up
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
  }


  function initializeDrawTools(map) {
    document
      .querySelectorAll(`input[type="radio"].${CONFIG.SELECTORS.RADIO_CLASS}`)
      .forEach((radio) => {
        radio.addEventListener('change', (e) => setDrawMode(map, e.target.value));
      });

    setDrawMode(map, 'draw-area')

    const clearBtn = document.getElementById('clearAllBtn');
    if (clearBtn) clearBtn.addEventListener('click', clearAllDrawings);

    const undoBtn = document.getElementById('undoBtn');
    if (undoBtn) undoBtn.addEventListener('click', undo);

    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) exportBtn.addEventListener('click', exportGeometries);  
  }

  document.addEventListener("DOMContentLoaded", (event) => {
    retrievedMap = document.getElementById('map1')._olMap;
    initializeDrawTools(retrievedMap);
  })

  function setCenter(coords) {
    retrievedMap.getView().setCenter(coords);
  }


</script>
{% endblock %}